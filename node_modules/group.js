var Neo4j = require('neo4j'),
	Step = require('step'),
	GROUPS_REFERENCE,
	db;

var Group = function(config){
	db = new Neo4j.GraphDatabase(config.databaseUrl + ':' + config.port);

	db.query("START n = node(0) MATCH (n) <-[:COLLECTIONS_REFERENCE]- () <-[:GROUPS_REFERENCE]- (grp_ref) RETURN grp_ref", function(errors, nodes) {
		if (errors) {
			// TODO: throw errors
		} else {
			GROUPS_REFERENCE = nodes[0]['grp_ref'];
		}
	});

	return {
		create: function(req, res, next){
			var newGroup = JSON.parse(req.body.data);

			var groupData = {
				title: newGroup.title,
				startDate: newGroup.startDate,
				endDate: newGroup.endDate
			}, groupNode, userInviteFollows, groupOwner, groupFollows;

			groupNode = db.createNode(groupData);

			Step(
				function getFollows(){
					if(newGroup.follow.length){
						var group = this.group();
						for (var i=0, j=newGroup.follow.length; i<j; i++) {
							db.getNodeById( newGroup.follow[i].id, group() );
						}
					} else {
						return [];
					}
				},
				function storeFollows(err, results){
					groupFollows = results;
					return 'hey'; // lol?
				},
				function getOwner(){
					db.getNodeById( newGroup.userid, this);
				},
				function storeOwner(err, result){
					groupOwner = result;
					return 'save group';
				},
				function getUserInviteFollows(){
					if(newGroup.requestFollow.length) {
						var group = this.group();
						for (var i=0, j=newGroup.requestFollow.length; i<j; i++) {
							db.getNodeById( newGroup.requestFollow[i].id, group() );
						}
					}
				},
				function storeUserInviteFollows(err, results){
					userInviteFollows = results;
					return 'next';
				},
				function saveGroup(){
					groupNode.save(this);
				},
				function indexGroup(){
					groupNode.index('group', 'title', newGroup.title, this.parallel() );
					groupNode.index('fulltext', 'group', newGroup.title, this.parallel() );
				},
				function relateGroup(err){
					groupNode.createRelationshipTo(GROUPS_REFERENCE, 'MEMBER_OF', {}, this.parallel() );
					groupOwner.createRelationshipTo( groupNode, 'CREATED', {}, this.parallel() );
				},
				function relateGroupFollows(){
					if (groupFollows.length) {
						var group = this.group();
						groupFollows.forEach(function(node){
							groupNode.createRelationshipTo(node, 'FOLLOWS', {}, group() );
						});
					}
				},
				function sendInviteFollows(){
					var invite = groupOwner._data.data.username + ' has invited you to follow ' +
						groupData.title;
					if(userInviteFollows.length) {
						var group = this.group();
						userInviteFollows.forEach(function(user){
							groupNode.createRelationshipTo(user, 'INVITE', { type: 'FOLLOWS', inviteText: invite }, group() );
						});
					}
				},
				function sendResults(err){
					res.json({ status: "success", data: groupNode.data });
				}
			);
		}
	};

};

module.exports = Group;