var Search = function(database){
	var db = database,
		Step = require('step');

	var searchTagsExact = function(query, callback){
		db.getIndexedNodes('tag', 'tag', query , callback);
	};

	var searchTagsFull = function(query, callback){
		var wildCards = 'tag:' + query + '*';
		db.queryNodeIndex('fulltext', wildCards , callback);
	};

	var searchUsersExact = function(query, callback){
		db.getIndexedNodes('user', 'username', query , callback);
	};

	var searchUsersFull = function(query, callback){
		var wildCards = 'username:' + query + '*';
		db.queryNodeIndex('fulltext', wildCards , callback);
	};

	var _tags = function(query, callback) {
		Step(
			function tagSearches(){
				searchTagsExact( query, this.parallel() );
				searchTagsFull( query, this.parallel() );
			},
			function searchesComplete(err, exact, matching){
				var tagResults = {
					type: "tags",
					query: query
				};

				if (exact.length) {
					tagResults.exactMatch = {
						id: exact[0].id,
						title: exact[0]._data.data.tag
					};
				}

				if (matching.length) {
					tagResults.matching = [];
					for(var i=0, j=matching.length; i<j; i++) {
						if(tagResults.exactMatch) {
							if (matching[i].id != tagResults.exactMatch.id) {
								tagResults.matching.push({
									id: matching[i].id,
									title: matching[i]._data.data.tag
								});
							}
						} else {
							tagResults.matching.push({
								id: matching[i].id,
								title: matching[i]._data.data.tag
							});
						}
					}
				}
				callback(undefined,tagResults);
			}
		);
	};

	var _users = function(query, callback){
		Step(
			function userSearches(){
				searchUsersExact( query, this.parallel() );
				searchUsersFull( query, this.parallel() );
			},
			function searchesComplete(err, exact, matching){
				var userResults = {
					type: "users",
					query: query
				};

				if (exact.length) {
					userResults.exactMatch = {
						id: exact[0].id,
						title: exact[0]._data.data.username
					};
				}

				if (matching.length) {
					userResults.matching = [];
					for(var i=0, j=matching.length; i<j; i++) {
						if(userResults.exactMatch) {
							if (matching[i].id != userResults.exactMatch.id) {
								userResults.matching.push({
									id: matching[i].id,
									title: matching[i]._data.data.username
								});
							}
						} else {
							userResults.matching.push({
								id: matching[i].id,
								title: matching[i]._data.data.username
							});
						}
					}
				}
				callback(undefined,userResults);
			}
		);
	};

	var _searchAll = function(query, property, callback){
		var error;

		Step(
			function runSearches(){
				db.queryNodeIndex('node_auto_index', property + ':' + '\"' + query + '\"', this);
				// db.getIndexedNodes('node_auto_index', property, query, this );
			},
			function searchResults(err, results){
				error = err;
				callback(error, results);
			}
		);
	};

	return {
		searchAll: _searchAll,
		tags: _tags,
		users: _users
	};

};

module.exports = Search;