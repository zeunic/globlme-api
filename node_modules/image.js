// var Image = require('./modules/image');
// var imageModule = new Image()

var CDN_URI;

module.exports = function(configOptions){

	// local dependancies?
	var Cloudfiles = require('cloudfiles'),
		Easyimage = require('easyimage'),
		Step = require('step');

	var config = { auth: { username: 'zeunicllc', apiKey: 'e4e2973174da5aeb4e63fbdd51f39527' } };
	var cloudfilesClient = Cloudfiles.createClient(config);
	cloudfilesClient.setAuth(function(){
		cloudfilesClient.getContainer('globl.me', true, function(test, container){
			CDN_URI = container.cdnUri + '/';
		});
	});

	// private functions
	var storeImage = function storeImage(sourcePath) {

	};

	return {
		convertImageToJpg: function(originalSourcePath, callback) {
				Easyimage.convert({
					src: originalSourcePath,
					dst: originalSourcePath +'.jpg',
					quality: 80
				}, callback);
		},
		cropSquare: function(imageInfo, offSetX, offSetY, callback){
			if(imageInfo.width > imageInfo.height) {
				imageInfo.width = imageInfo.height;
			} else if (imageInfo.height > imageInfo.width) {
				imageInfo.height = imageInfo.width;
			}

			Easyimage.thumbnail(
				{
					src: imageInfo.name, dst:originalSourcePath + '_square.jpg',
					width: imageInfo.width, height: imageInfo.height,
					x:offSetX, y:offSetY
				},
				function(err, stdout, stderr) {
					if (err) throw err;
					return callback(arguments);
				}
			);
		},
		saveImageSizes: function(originalSourcePath, callback){
			var sizes = [ 80, 200, 320, 480, 640, 800 ];

			Step(
				function processAllSizes(){
					var group = this.group();
					sizes.forEach(function(size){
						Easyimage.resize({
							src: originalSourcePath,
							dst: originalSourcePath + '_' + size + '.jpg',
							width: size,
							height: size,
							quality: 80
						}, group() );
					});
				},
				function sendResults(err, imageResizedResults){
					callback(undefined,imageResizedResults);
				}
			);
		},
		storeImagesToCDN: function(images, remotePath, callback){
			var imageUrls = [];
			Step(
				function uploadImages(){
					var group = this.group();
					images.forEach(function(image){
						console.log('saving an image...' + image);
						var fullPath = remotePath + '/' + image.name;
						cloudfilesClient.setAuth(function(){
							console.log('auth set...');
							cloudfilesClient.addFile(
								'globl.me', // will need to fix containers soon
								{ remote: fullPath, local: '_uploads/' + image.name },
								function(err, uploaded){
									console.log('addfile is done...');
									console.log(err, uploaded);
							});
						});

						(group()(undefined,CDN_URI + fullPath));
					});
				},
				function sendResults(err, results) {
					console.log('group seems to be finished');
					callback(undefined,results);
				}
			);
		}
	};
};